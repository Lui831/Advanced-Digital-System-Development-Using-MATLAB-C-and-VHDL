%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                          %
%          Generated by MATLAB 25.2 and Fixed-Point Designer 25.2          %
%                                                                          %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%#codegen
function [y,dydx,d2ydx2,y0,y1] = prediction_fixpt(x,w0,b0,w1,b1)
    % Preprocessing for vectorisation of the output
    fm = get_fimath();

    Nn = fi(length(w0), 0, 4, 0, fm);
    N  = fi(length(x), 0, 5, 0, fm);
    
    W0 = fi(repmat(w0,1,fi_toint(N)), 1, 14, 9, fm);
    B0 = fi(repmat(b0,1,fi_toint(N)), 1, 14, 9, fm);
    W1 = fi(repmat(w1,1,fi_toint(N)), 1, 14, 13, fm);
    X  = fi(repmat(x,fi_toint(Nn),1), 0, 14, 13, fm);
    
    % The prediction of y(x)
    z_i   = fi(call_custom_fcn_s1(W0.*X+B0), 0, 14, 13, fm);     % NnxN matrix
    mySzp = fi(call_custom_fcn_s1(W0.*X+B0).*... % Prime of the sigmoid at z_i
             (fi(1, 0, 1, 0, fm)-call_custom_fcn_s1(W0.*X+B0)), 0, 14, 16, fm);
    mySzpp = fi(mySzp.*(fi_signed(fi(1, 0, 1, 0, fm))-fi(2, 0, 2, 0, fm)*call_custom_fcn_s1(w0*x+b0)), 1, 14, 16, fm);
         
    y     = fi(sum(W1.*z_i)+b1, 1, 14, 17, fm);        % The prediction at current batch
    
    % The prediction of dy/dx 
    dydx  = fi(sum(W1.*W0.*mySzp), 1, 14, 14, fm);
    
    % The prediction of d2y/dx2 
    d2ydx2 = fi(sum(w1.*w0.^2.*mySzpp), 1, 14, 11, fm);
    
    % The prediction of y(0). N.B. scalar value
    y0    = fi(sum(w1.*call_custom_fcn_s2(b0))+b1, 1, 14, 22, fm);
    
    % The prediction of y(1). N.B. scalar value
    y1    = fi(sum(w1.*call_custom_fcn_s2(w0+b0))+b1, 1, 14, 22, fm);
end

function y = call_custom_fcn_s1(x)
      fm = get_fimath();

      y = fi(custom_fcn_s1(x), 0, 14, 13, fm);
end

function y = call_custom_fcn_s2(x)
      fm = get_fimath();

      y = fi(custom_fcn_s2(x), 0, 14, 13, fm);
end

function y = custom_fcn_s1(x)
  fm = get_fimath();

  [fmo_1,fmo_2] = size(x);
  L = fi(fmo_1, 0, 4, 0, fm);
  C = fi(fmo_2, 0, 5, 0, fm);
  % Initialize the output array
  y = fi(zeros(L, C), 0, 14, 13, fm);
   for i= 1:L
       for j=1:C
          y(i,j) = 1./(1+exp(-x(i,j)));
       end
   end   
end

function y = custom_fcn_s2(x)
  fm = get_fimath();

  [fmo_1,fmo_2] = size(x);
  L = fi(fmo_1, 0, 4, 0, fm);
  C = fi(fmo_2, 0, 1, 0, fm);
  % Initialize the output array
  y = fi(zeros(L, C), 0, 14, 13, fm);
   for i= 1:L
       for j=1:C
          y(i,j) = 1./(1+exp(-x(i,j)));
       end
   end   
end



function y = fi_signed(a)
    coder.inline( 'always' );
    if isfi( a ) && ~(issigned( a ))
        nt = numerictype( a );
        new_nt = numerictype( 1, nt.WordLength + 1, nt.FractionLength );
        y = fi( a, new_nt, fimath( a ) );
    else
        y = a;
    end
end


function y = fi_toint(u)
    coder.inline( 'always' );
    if isfi( u )
        nt = numerictype( u );
        s = nt.SignednessBool;
        wl = nt.WordLength;
        if s
            y = int32( fi( u, s, wl, 0, hdlfimath ) );
        else
            y = uint32( fi( u, s, wl, 0, hdlfimath ) );
        end
    else
        y = int32( u );
    end
end

function fm = get_fimath()
	fm = fimath('RoundingMethod', 'Floor',...
	     'OverflowAction', 'Wrap',...
	     'ProductMode','FullPrecision',...
	     'MaxProductWordLength', 128,...
	     'SumMode','FullPrecision',...
	     'MaxSumWordLength', 128);
end
